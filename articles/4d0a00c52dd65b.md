---
title: "Unity 2022アップデート時に発生したエラー対応メモ"
emoji: "🛠️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [unity, iOS, AdMob, firebase]
published: true
---

とあるUnityアプリ開発のプロジェクトにて、開発環境をUnity 2021から2022へアップデートした際に発生したエラーの対応メモです。


:::message
環境: Unity 2021.3.37f1 -> 2022.3.25f1
:::

## Reference has errors 'Google.IOSResolver'.

```shell
Assembly 'Library/ScriptAssemblies/Assembly-CSharp-Editor.dll' will not be loaded due to errors:
Reference has errors 'Google.IOSResolver'.
```

### 原因
UnityにiOSモジュールがインストールされていない場合に発生するエラー。

### 対応

Unity HubのInstallsにて対象バージョンのUnityを選択。`Add modules`から `iOS Build Support` を追加して解消。

![](https://storage.googleapis.com/zenn-user-upload/a2730efac6c8-20240605.png)

![](https://storage.googleapis.com/zenn-user-upload/f53a8066dc61-20240605.png)

### 参考

> Check if you have iOS module installed for your unity editor. If not, install it from unity hub.
> 
> https://forum.unity.com/threads/google-iosresolver-will-not-be-loaded-in-2021-1-11f1-and-later.1128617/#post-9101890

## System.InvalidOperationException: Insecure connection not allowed


```shell
Job failed with exception: System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---> System.InvalidOperationException: Insecure connection not allowed
  at (wrapper managed-to-native) UnityEngine.Networking.UnityWebRequest.BeginWebRequest(UnityEngine.Networking.UnityWebRequest)
  at UnityEngine.Networking.UnityWebRequest.SendWebRequest () [0x00001] in <ce006d9cdd7f42a88f73d37c00d20828>:0 
  at (wrapper managed-to-native) System.Reflection.RuntimeMethodInfo.InternalInvoke(System.Reflection.RuntimeMethodInfo,object,object[],System.Exception&)
  at System.Reflection.RuntimeMethodInfo.Invoke (System.Object obj, System.Reflection.BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture) [0x0006a] in <b11ba2a8fbf24f219f7cc98532a11304>:0 
   --- End of inner exception stack trace ---
  at System.Reflection.RuntimeMethodInfo.Invoke (System.Object obj, System.Reflection.BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture) [0x00083] in <b11ba2a8fbf24f219f7cc98532a11304>:0 
  at System.Reflection.MethodBase.Invoke (System.Object obj, System.Object[] parameters) [0x00000] in <b11ba2a8fbf24f219f7cc98532a11304>:0 
  at Google.PortableWebRequest.StartRequest (Google.PortableWebRequest+HttpMethod method, System.String url, System.Collections.Generic.IDictionary`2[TKey,TValue] headers, UnityEngine.WWWForm form) [0x0019e] in <3d721d59d99942a585ced249e28ec6ca>:0 
  at Google.PortableWebRequest+<StartRequestOnMainThread>c__AnonStorey6.<>m__C () [0x00000] in <3d721d59d99942a585ced249e28ec6ca>:0 
  at Google.RunOnMainThread.ExecuteNext () [0x0003d] in <3d721d59d99942a585ced249e28ec6ca>:0 
UnityEngine.Debug:LogError (object)
Google.RunOnMainThread:ExecuteNext ()
Google.RunOnMainThread:<ExecuteAllUnnested>m__12 ()
Google.RunOnMainThread:RunAction (System.Action)
Google.RunOnMainThread:ExecuteAllUnnested (bool)
Google.RunOnMainThread:ExecuteAll ()
UnityEditor.EditorApplication:Internal_CallUpdateFunctions ()
```

### 原因
Unity 2022以後では、HTTP経由でのコンテンツダウンロードを許可しない設定がデフォルトとなっている。

> HTTP 経由でのコンテンツのダウンロードを許可するかどうか指定します。選択可能なオプションは Not allowed、Allowed in Development builds only、Always allowed です。デフォルトのオプションは Not allowed です。これは、より安全なプロトコルである HTTPS が推奨されるためです。
>
> https://docs.unity3d.com/ja/2022.3/Manual/class-PlayerSettingsWebGL.html

FirebaseやAdMobなど、Google系のデータ解析・広告SDKを導入している場合、Editorの使用状況レポート送信でhttp通信が行われていることが原因。

> EditorMeasurement used to use http:// instead of https:// to report editor usage. This is causing later version of Unity to log warnings and errors. Even though this is harmless, the logs still looks concerning.
> 
> https://github.com/googlesamples/unity-jar-resolver/pull/548

### 対応
[unity-jar-resolver](https://github.com/googlesamples/unity-jar-resolver)のドキュメントを参照し、該当するレポート送信を無効にする。
以下設定のEnable Analytics Reportingのチェックを外し、OKボタンクリックで保存して解消。

##### Assets > External Dependency Manager > Version Handler > Settings

![](https://storage.googleapis.com/zenn-user-upload/d62d6884bd83-20240605.png)

なお、UnityエディタのProject Settingsにて `Allow downloads over HTTP` を `Always allowed` へ変更してもエラー解消可能だが、HTTP通信は非推奨であるため、前述の設定変更を行うか、外部通信時の接続対象をHTTPSに限定する形が望ましい。

### 参考

#### Enable Analytics Reportingの設定変更

> Thank you for reporting this issue. Seems like Unity 2022 added some security feature which blocks the non-https web request. I wonder why it used http in the first place.
> 
> At the meantime, as a workaround, I would recommend you to disable Analytics reporting from our editor tools for now. Here are all the settings:
> 
> EDM4U: Assets > External Dependency Manager > Version Handler > Settings > Enable Analytics Reporting
> Firebase: Windows > Firebase > Documentation > Enable Analytics Reporting (At the very bottom)
> 
> https://github.com/googlesamples/unity-jar-resolver/issues/484#issuecomment-993910648

#### Allow downloads over HTTPの設定変更

> Solved this by (Workaround): Edit -> Project Settings -> Player -> Other Settings -> Configuration -> Allow downloads over HTTP
set "Always allowed"...
>
> https://forum.unity.com/threads/job-failed-with-exception-system-reflection-targetinvocationexception-unity-error.1294134/#post-8590033