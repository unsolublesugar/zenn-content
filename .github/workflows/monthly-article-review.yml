name: Monthly Article Review

on:
  schedule:
    # æ¯æœˆ1æ—¥ã®9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 1 * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      target_count:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡è¨˜äº‹æ•°'
        required: false
        default: '5'
        type: string

jobs:
  article-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install
        
      - name: Find articles for review
        id: find-articles
        run: |
          # å…¬é–‹è¨˜äº‹ã‹ã‚‰å¤ã„è¨˜äº‹ã‚’ç‰¹å®šï¼ˆ3ãƒ¶æœˆä»¥ä¸Šå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          target_count="${{ github.event.inputs.target_count || '5' }}"
          
          echo "## å¯¾è±¡è¨˜äº‹ã®ç‰¹å®š" >> $GITHUB_STEP_SUMMARY
          
          # published: true ã®è¨˜äº‹ã‚’å–å¾—ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆ
          articles=$(find articles -name "*.md" -exec grep -l "published: true" {} \; | \
                    xargs ls -lt | \
                    head -n $target_count | \
                    awk '{print $NF}')
          
          echo "review_targets<<EOF" >> $GITHUB_OUTPUT
          echo "$articles" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "å¯¾è±¡è¨˜äº‹:" >> $GITHUB_STEP_SUMMARY
          echo "$articles" | while read article; do
            if [ -n "$article" ]; then
              title=$(grep "^title:" "$article" | cut -d'"' -f2)
              echo "- $article: $title" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
      - name: Generate review report
        id: review
        run: |
          report_file="review-report-$(date +%Y%m).md"
          current_date="$(date +%Yå¹´%mæœˆ)"
          
          cat > "$report_file" << EOF
          # ğŸ“Š æœˆæ¬¡è¨˜äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ - $current_date
          
          è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®è¦³ç‚¹ã§è¨˜äº‹ã‚’è©•ä¾¡ã—ã¾ã—ãŸï¼š
          
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          - âœ… æƒ…å ±ã®å¤ã•ãƒã‚§ãƒƒã‚¯
          - âœ… èª­ã¿ã‚„ã™ã•ã‚¹ã‚³ã‚¢
          - âœ… é–¢é€£è¨˜äº‹ææ¡ˆ
          - âœ… SEOæ”¹å–„ææ¡ˆ
          
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
          
          EOF
          
          # å„è¨˜äº‹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
          echo '${{ steps.find-articles.outputs.review_targets }}' | while read article; do
            if [ -n "$article" ] && [ -f "$article" ]; then
              echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­: $article"
              
              # è¨˜äº‹ã®åŸºæœ¬æƒ…å ±ã‚’å–å¾—
              title=$(grep "^title:" "$article" | cut -d'"' -f2 || echo "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜")
              topics=$(grep "^topics:" "$article" | cut -d'[' -f2 | cut -d']' -f1 || echo "ãƒˆãƒ”ãƒƒã‚¯ä¸æ˜")
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚commitæ—¥æ™‚ã‚’å–å¾—ï¼ˆGit logãƒ™ãƒ¼ã‚¹ï¼‰
              file_date=$(git log -1 --format=%ct -- "$article" 2>/dev/null || echo "0")
              current_date=$(date +%s)
              days_old=$(( (current_date - file_date) / 86400 ))
              
              cat >> "$report_file" << EOF
          ### ğŸ“„ $title
          
          **ãƒ•ã‚¡ã‚¤ãƒ«**: \`$article\`  
          **ãƒˆãƒ”ãƒƒã‚¯**: $topics  
          **æœ€çµ‚æ›´æ–°**: ${days_old}æ—¥å‰  
          
          #### ğŸ” æƒ…å ±ã®å¤ã•ãƒã‚§ãƒƒã‚¯
          EOF
              
              if [ $days_old -gt 90 ]; then
                cat >> "$report_file" << EOF
          âš ï¸ **è¦æ›´æ–°**: 90æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“
          - æœ€æ–°ã®æŠ€è¡“æƒ…å ±ã®ç¢ºèªãŒå¿…è¦
          - å¤–éƒ¨ãƒªãƒ³ã‚¯ã®ç¢ºèª
          - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
          EOF
              else
                echo "âœ… **æœ€æ–°**: æœ€è¿‘æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™" >> "$report_file"
              fi
              
              cat >> "$report_file" << EOF
          
          #### ğŸ“ æ”¹å–„ææ¡ˆ
          - [ ] æœ€æ–°æƒ…å ±ã®ç¢ºèªãƒ»æ›´æ–°
          - [ ] é–¢é€£è¨˜äº‹ãƒªãƒ³ã‚¯ã®è¿½åŠ 
          - [ ] SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¦‹ç›´ã—
          - [ ] èª­ã¿ã‚„ã™ã•ã®æ”¹å–„
          
          ---
          
          EOF
            fi
          done
          
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFile = '${{ steps.review.outputs.report_file }}';
            
            let reportContent = '';
            try {
              reportContent = fs.readFileSync(reportFile, 'utf8');
            } catch (error) {
              reportContent = '# ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼\n\nãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
            
            const issueTitle = `ğŸ“Š æœˆæ¬¡è¨˜äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().getFullYear()}å¹´${String(new Date().getMonth() + 1).padStart(2, '0')}æœˆ`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: reportContent,
              labels: ['article-review', 'monthly-task', 'enhancement']
            });
            
      - name: Upload review report
        uses: actions/upload-artifact@v4
        with:
          name: monthly-review-report
          path: review-report-*.md
          retention-days: 30