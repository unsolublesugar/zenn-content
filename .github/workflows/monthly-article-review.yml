name: Monthly Article Review

on:
  schedule:
    # æ¯æœˆ1æ—¥ã®9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 1 * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      target_count:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡è¨˜äº‹æ•°'
        required: false
        default: '5'
        type: string

jobs:
  article-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦git logã‚’æ­£å¸¸å‹•ä½œã•ã›ã‚‹
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install
        
      - name: Find articles for review
        id: find-articles
        run: |
          # å…¬é–‹è¨˜äº‹ã‹ã‚‰å¤ã„è¨˜äº‹ã‚’ç‰¹å®šï¼ˆ3ãƒ¶æœˆä»¥ä¸Šå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          target_count="${{ github.event.inputs.target_count || '5' }}"
          
          echo "## å¯¾è±¡è¨˜äº‹ã®ç‰¹å®š" >> $GITHUB_STEP_SUMMARY
          
          # published: true ã®è¨˜äº‹ã‚’å–å¾—ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆ
          articles=$(find articles -name "*.md" -exec grep -l "published: true" {} \; | \
                    xargs ls -lt | \
                    head -n $target_count | \
                    awk '{print $NF}')
          
          echo "review_targets<<EOF" >> $GITHUB_OUTPUT
          echo "$articles" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "å¯¾è±¡è¨˜äº‹:" >> $GITHUB_STEP_SUMMARY
          echo "$articles" | while read article; do
            if [ -n "$article" ]; then
              title=$(grep "^title:" "$article" | cut -d'"' -f2)
              echo "- $article: $title" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
      - name: Generate review report
        id: review
        run: |
          report_file="review-report-$(date +%Y%m).md"
          current_date="$(date +%Yå¹´%mæœˆ)"
          
          cat > "$report_file" << EOF
          # ğŸ“Š æœˆæ¬¡è¨˜äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ - $current_date
          
          è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®è¦³ç‚¹ã§è¨˜äº‹ã‚’è©•ä¾¡ã—ã¾ã—ãŸï¼š
          
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          - âœ… æƒ…å ±ã®å¤ã•ãƒã‚§ãƒƒã‚¯
          - âœ… èª­ã¿ã‚„ã™ã•ã‚¹ã‚³ã‚¢
          - âœ… é–¢é€£è¨˜äº‹ææ¡ˆ
          - âœ… SEOæ”¹å–„ææ¡ˆ
          
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
          
          EOF
          
          # å„è¨˜äº‹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
          echo '${{ steps.find-articles.outputs.review_targets }}' | while read article; do
            if [ -n "$article" ] && [ -f "$article" ]; then
              echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­: $article"
              
              # è¨˜äº‹ã®åŸºæœ¬æƒ…å ±ã‚’å–å¾—
              title=$(grep "^title:" "$article" | sed 's/title: *"//' | sed 's/"$//' || echo "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜")
              
              # publication_nameã¨article_idã‚’å–å¾—ã—ã¦ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
              # Front Matterå†…ã®publication_nameã®ã¿ã‚’å–å¾—ï¼ˆå…ˆé ­10è¡Œã‹ã‚‰æ¤œç´¢ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆé™¤å¤–ï¼‰
              publication_name=$(head -10 "$article" | grep "^publication_name:" | grep -v "#" | cut -d'"' -f2 || echo "")
              article_id=$(basename "$article" .md)
              
              if [ -n "$publication_name" ]; then
                article_url="https://zenn.dev/$publication_name/articles/$article_id"
              else
                article_url="https://zenn.dev/unsoluble_sugar/articles/$article_id"
              fi
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚commitæ—¥æ™‚ã‚’å–å¾—ï¼ˆGit logãƒ™ãƒ¼ã‚¹ï¼‰
              file_date=$(git log -1 --format=%ct -- "$article" 2>/dev/null || echo "0")
              current_date=$(date +%s)
              days_old=$(( (current_date - file_date) / 86400 ))
              
              cat >> "$report_file" << EOF
          ### ğŸ“„ $title
          
          **è¨˜äº‹ãƒªãƒ³ã‚¯**: $article_url  
          **ãƒ•ã‚¡ã‚¤ãƒ«**: \`$article\`  
          **æœ€çµ‚æ›´æ–°**: ${days_old}æ—¥å‰  
          
          #### ğŸ” æƒ…å ±ã®å¤ã•ãƒã‚§ãƒƒã‚¯
          EOF
              
              if [ $days_old -gt 90 ]; then
                cat >> "$report_file" << EOF
          âš ï¸ **è¦æ›´æ–°**: 90æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“
          - æœ€æ–°ã®æŠ€è¡“æƒ…å ±ã®ç¢ºèªãŒå¿…è¦
          - å¤–éƒ¨ãƒªãƒ³ã‚¯ã®ç¢ºèª
          - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
          EOF
              else
                echo "âœ… **æœ€æ–°**: æœ€è¿‘æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™" >> "$report_file"
              fi
              
              # è¨˜äº‹ã®è©³ç´°åˆ†æã‚’å®Ÿè¡Œ
              echo "è©³ç´°åˆ†æä¸­: $article"
              
              # è¨˜äº‹å†…å®¹ã‚’åˆ†æï¼ˆå®‰å…¨ãªå¤‰æ•°å‡¦ç†ï¼‰
              word_count=$(wc -c < "$article" 2>/dev/null | tr -d ' ' || echo "0")
              heading_count=$(grep -c "^#" "$article" 2>/dev/null || echo "0")
              code_block_count=$(grep -c "\`\`\`\|\`" "$article" 2>/dev/null || echo "0")
              image_count=$(grep -c "!\[" "$article" 2>/dev/null || echo "0")
              link_count=$(grep -c "http" "$article" 2>/dev/null || echo "0")
              
              # å¤‰æ•°ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°å€¤ã§ãªã„å ´åˆã¯0ã«è¨­å®šï¼‰
              word_count=${word_count//[^0-9]/}
              word_count=${word_count:-0}
              heading_count=${heading_count//[^0-9]/}
              heading_count=${heading_count:-0}
              code_block_count=${code_block_count//[^0-9]/}
              code_block_count=${code_block_count:-0}
              image_count=${image_count//[^0-9]/}
              image_count=${image_count:-0}
              link_count=${link_count//[^0-9]/}
              link_count=${link_count:-0}
              
              # æŠ€è¡“çš„ãªå¤ã•ã®å…†å€™ã‚’æ¤œå‡ºï¼ˆãƒ•ãƒ©ã‚°ãƒ™ãƒ¼ã‚¹ï¼‰
              has_old_dates=false
              has_old_versions=false
              has_old_links=false
              
              if grep -q "2020\|2021\|2022" "$article"; then
                has_old_dates=true
              fi
              if grep -qi "windows 10\|node 14\|npm 6" "$article"; then
                has_old_versions=true
              fi
              if grep -qi "http://\|docs.microsoft.com.*powershell" "$article"; then
                has_old_links=true
              fi
              
              # è¨˜äº‹ã®å¼·ã¿ã‚’åˆ†æï¼ˆãƒ•ãƒ©ã‚°ãƒ™ãƒ¼ã‚¹ï¼‰
              has_rich_images=false
              has_rich_code=false
              has_good_structure=false
              
              if [ $image_count -gt 5 ]; then
                has_rich_images=true
              fi
              if [ $code_block_count -gt 10 ]; then
                has_rich_code=true
              fi
              if [ $heading_count -gt 5 ]; then
                has_good_structure=true
              fi
              
              cat >> "$report_file" << EOF
          
          #### ğŸ“Š è¨˜äº‹åˆ†æ
          - **æ–‡å­—æ•°**: ${word_count}æ–‡å­—
          - **è¦‹å‡ºã—æ•°**: ${heading_count}å€‹
          - **ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯**: ${code_block_count}å€‹
          - **ç”»åƒæ•°**: ${image_count}æš
          - **å¤–éƒ¨ãƒªãƒ³ã‚¯**: ${link_count}å€‹
          
          #### ğŸ” è©³ç´°åˆ†æçµæœ
          EOF
          
              # AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
              echo "          **ğŸ¤– AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ**" >> "$report_file"
              
              # åŸºæœ¬ã‚¹ã‚³ã‚¢ç®—å‡ºï¼ˆæ•´æ•°ãƒ™ãƒ¼ã‚¹ï¼‰
              structure_score=30
              content_score=30
              freshness_score=30
              
              # æ§‹é€ ã‚¹ã‚³ã‚¢ï¼ˆè¦‹å‡ºã—æ•°ã‹ã‚‰ï¼‰
              if [ $heading_count -gt 10 ]; then
                structure_score=45
              elif [ $heading_count -gt 5 ]; then
                structure_score=40
              fi
              
              # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚³ã‚¢ï¼ˆç”»åƒã€ã‚³ãƒ¼ãƒ‰ã€ãƒªãƒ³ã‚¯ã®åˆè¨ˆã‹ã‚‰ï¼‰
              total_content=$(( image_count + code_block_count + link_count ))
              if [ $total_content -gt 30 ]; then
                content_score=45
              elif [ $total_content -gt 15 ]; then
                content_score=40
              elif [ $total_content -gt 5 ]; then
                content_score=35
              fi
              
              # æ–°é®®åº¦ã‚¹ã‚³ã‚¢ï¼ˆæ—¥æ•°ã‹ã‚‰ï¼‰
              if [ $days_old -lt 90 ]; then
                freshness_score=45
              elif [ $days_old -lt 180 ]; then
                freshness_score=40
              elif [ $days_old -lt 365 ]; then
                freshness_score=35
              else
                freshness_score=25
              fi
              
              # ç·åˆã‚¹ã‚³ã‚¢ç®—å‡ºï¼ˆæ•´æ•°æ¼”ç®—ï¼‰
              total_score=$(( (structure_score + content_score + freshness_score) / 10 ))
              
              echo "          " >> "$report_file"
              echo "          **ç·åˆè©•ä¾¡**: ${total_score}/15 (æ§‹é€ : ${structure_score}/50, ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: ${content_score}/50, æ–°é®®åº¦: ${freshness_score}/50)" >> "$report_file"
              echo "          " >> "$report_file"
              
              # è¨˜äº‹ã®ç‰¹å¾´ã‚’åˆ†æ
              if [ $code_block_count -gt 15 ]; then
                echo "          âœ… **è±Šå¯Œãªã‚³ãƒ¼ãƒ‰ä¾‹**: ${code_block_count}å€‹ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å®Ÿè£…æ‰‹é †ã‚’å…·ä½“çš„ã«èª¬æ˜" >> "$report_file"
              fi
              
              if [ $image_count -gt 5 ]; then
                echo "          âœ… **è¦–è¦šçš„èª¬æ˜**: ${image_count}æšã®ç”»åƒã§ç†è§£ã‚’ä¿ƒé€²" >> "$report_file"
              fi
              
              if [ $heading_count -gt 10 ]; then
                echo "          âœ… **æ§‹é€ åŒ–**: ${heading_count}å€‹ã®è¦‹å‡ºã—ã§æƒ…å ±ã‚’æ•´ç†" >> "$report_file"
              fi
              
              if [ $days_old -lt 90 ]; then
                echo "          âœ… **æœ€æ–°æƒ…å ±**: æœ€è¿‘æ›´æ–°ã•ã‚ŒãŸæ–°é®®ãªå†…å®¹" >> "$report_file"
              elif [ $days_old -gt 365 ]; then
                echo "          âš ï¸  **è¦æ›´æ–°**: 1å¹´ä»¥ä¸ŠçµŒéã€æœ€æ–°æƒ…å ±ã®ç¢ºèªæ¨å¥¨" >> "$report_file"
              fi
              
              echo "          " >> "$report_file"
          
              # æŠ€è¡“çš„ãªå¤ã•ã®å…†å€™ã‚’å‡ºåŠ›
              if [ "$has_old_dates" = true ] || [ "$has_old_versions" = true ] || [ "$has_old_links" = true ]; then
                echo "          **âš ï¸ æŠ€è¡“çš„ãªå¤ã•ã®å…†å€™**" >> "$report_file"
                if [ "$has_old_dates" = true ]; then
                  echo "          - å¤ã„æ—¥ä»˜æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã‚ã‚Š" >> "$report_file"
                fi
                if [ "$has_old_versions" = true ]; then
                  echo "          - å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã‚ã‚Š" >> "$report_file"
                fi
                if [ "$has_old_links" = true ]; then
                  echo "          - æ›´æ–°ãŒå¿…è¦ãªãƒªãƒ³ã‚¯ã‚’å«ã‚€å¯èƒ½æ€§ã‚ã‚Š" >> "$report_file"
                fi
                echo "" >> "$report_file"
              fi
              
              # è¨˜äº‹ã®å¼·ã¿ã‚’å‡ºåŠ›
              if [ "$has_rich_images" = true ] || [ "$has_rich_code" = true ] || [ "$has_good_structure" = true ]; then
                echo "          **âœ… è¨˜äº‹ã®å¼·ã¿**" >> "$report_file"
                if [ "$has_rich_images" = true ]; then
                  echo "          - è±Šå¯Œãªç”»åƒï¼ˆ${image_count}æšï¼‰ã§è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„" >> "$report_file"
                fi
                if [ "$has_rich_code" = true ]; then
                  echo "          - é©åˆ‡ãªã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä½¿ç”¨ï¼ˆ${code_block_count}å€‹ï¼‰" >> "$report_file"
                fi
                if [ "$has_good_structure" = true ]; then
                  echo "          - æ§‹é€ åŒ–ã•ã‚ŒãŸè¦‹å‡ºã—ï¼ˆ${heading_count}å€‹ï¼‰" >> "$report_file"
                fi
                echo "" >> "$report_file"
              fi
              
              cat >> "$report_file" << EOF
          
          #### ğŸ“ å…·ä½“çš„æ”¹å–„ææ¡ˆ
          EOF
              
              if [ $days_old -gt 365 ]; then
                cat >> "$report_file" << EOF
          **ğŸ”„ å„ªå…ˆåº¦ï¼šé«˜ï¼ˆ1å¹´ä»¥ä¸ŠçµŒéï¼‰**
          - [ ] æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¸ã®æ›´æ–°ï¼ˆOSã€ãƒ„ãƒ¼ãƒ«ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
          - [ ] å¤–éƒ¨ãƒªãƒ³ã‚¯ã®ç”Ÿå­˜ç¢ºèªã¨æœ€æ–°åŒ–
          - [ ] å»ƒæ­¢ã•ã‚ŒãŸAPI/æ‰‹æ³•ã®ç¢ºèªã¨ä»£æ›¿æ¡ˆã®æç¤º
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£æƒ…å ±ã®è¿½åŠ ãƒ»æ›´æ–°
          EOF
              elif [ $days_old -gt 180 ]; then
                cat >> "$report_file" << EOF
          **ğŸ”„ å„ªå…ˆåº¦ï¼šä¸­ï¼ˆåŠå¹´ä»¥ä¸ŠçµŒéï¼‰**
          - [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç¢ºèªãƒ»æ›´æ–°
          - [ ] å¤–éƒ¨ãƒªãƒ³ã‚¯ã®ç¢ºèª
          - [ ] æœ€æ–°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã®æ¯”è¼ƒ
          EOF
              else
                cat >> "$report_file" << EOF
          **ğŸ”„ å„ªå…ˆåº¦ï¼šä½ï¼ˆæœ€æ–°ï¼‰**
          - [ ] é–¢é€£è¨˜äº‹ãƒªãƒ³ã‚¯ã®è¿½åŠ 
          - [ ] SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€é©åŒ–
          - [ ] èª­ã¿ã‚„ã™ã•ã®å¾®èª¿æ•´
          EOF
              fi
              
              cat >> "$report_file" << EOF
          
          **ğŸ“ˆ å“è³ªå‘ä¸Šææ¡ˆ**
          - [ ] ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
          - [ ] å®Ÿè·µçš„ãªä½¿ç”¨ä¾‹ã®æ‹¡å……
          - [ ] é–¢é€£æŠ€è¡“ã¨ã®æ¯”è¼ƒãƒ»é€£æºæ–¹æ³•
          - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ
          
          ---
          
          EOF
            fi
          done
          
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFile = '${{ steps.review.outputs.report_file }}';
            
            let reportContent = '';
            try {
              reportContent = fs.readFileSync(reportFile, 'utf8');
            } catch (error) {
              reportContent = '# ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼\n\nãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
            
            const issueTitle = `ğŸ“Š æœˆæ¬¡è¨˜äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().getFullYear()}å¹´${String(new Date().getMonth() + 1).padStart(2, '0')}æœˆ`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: reportContent,
              labels: ['article-review', 'monthly-task', 'enhancement']
            });
            
      - name: Upload review report
        uses: actions/upload-artifact@v4
        with:
          name: monthly-review-report
          path: review-report-*.md
          retention-days: 30